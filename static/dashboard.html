<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Sable WebChat</title>
<style>
  /* â”€â”€ Reset & base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  :root {
    --bg:        #0d1117;
    --surface:   #161b22;
    --border:    #30363d;
    --accent:    #7c3aed;
    --accent2:   #a855f7;
    --text:      #e6edf3;
    --text-dim:  #8b949e;
    --user-bg:   #21262d;
    --bot-bg:    #1a1f2e;
    --success:   #3fb950;
    --warning:   #d29922;
    --danger:    #f85149;
    --radius:    12px;
    --font:      'Inter', system-ui, -apple-system, sans-serif;
    --mono:      'JetBrains Mono', 'Fira Code', monospace;
  }
  html, body { height: 100%; overflow: hidden; }
  body {
    font-family: var(--font);
    background: var(--bg);
    color: var(--text);
    display: flex;
    flex-direction: column;
    height: 100vh;
  }
  /* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #app {
    display: grid;
    grid-template-columns: 260px 1fr;
    grid-template-rows: 56px 1fr;
    height: 100vh;
  }
  /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #header {
    grid-column: 1 / -1;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    padding: 0 20px;
    gap: 14px;
  }
  #header h1 { font-size: 1.05rem; font-weight: 700; letter-spacing: -.3px; }
  #header h1 span { color: var(--accent2); }
  .pill {
    font-size: .7rem;
    font-weight: 600;
    padding: 2px 8px;
    border-radius: 999px;
    letter-spacing: .04em;
  }
  .pill-secure { background: rgba(63,185,80,.15); color: var(--success); border: 1px solid rgba(63,185,80,.35); }
  #conn-dot {
    width: 9px; height: 9px;
    border-radius: 50%;
    background: var(--danger);
    flex-shrink: 0;
    transition: background .3s;
  }
  #conn-dot.on  { background: var(--success); box-shadow: 0 0 6px var(--success); }
  #conn-label { font-size: .75rem; color: var(--text-dim); }
  #header-right { margin-left: auto; display: flex; align-items: center; gap: 12px; }
  #model-badge {
    font-family: var(--mono);
    font-size: .7rem;
    padding: 3px 10px;
    background: rgba(124,58,237,.15);
    border: 1px solid rgba(124,58,237,.35);
    border-radius: 999px;
    color: var(--accent2);
  }
  /* â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #sidebar {
    background: var(--surface);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  #sidebar-header {
    padding: 14px 16px 10px;
    font-size: .7rem;
    font-weight: 700;
    letter-spacing: .08em;
    color: var(--text-dim);
    text-transform: uppercase;
    border-bottom: 1px solid var(--border);
  }
  #sessions-list {
    flex: 1;
    overflow-y: auto;
    padding: 8px 0;
  }
  .session-item {
    padding: 8px 16px;
    cursor: pointer;
    border-radius: 6px;
    margin: 2px 6px;
    transition: background .15s;
    font-size: .82rem;
  }
  .session-item:hover { background: rgba(255,255,255,.06); }
  .session-item.active { background: rgba(124,58,237,.2); color: var(--accent2); }
  .session-item .s-id  { font-family: var(--mono); font-size: .7rem; color: var(--text-dim); }
  .session-item .s-ch  { font-weight: 600; }
  .session-item .s-n   { font-size: .68rem; color: var(--text-dim); margin-top: 1px; }
  #sidebar-footer { padding: 10px 14px; border-top: 1px solid var(--border); }
  #stats { font-size: .72rem; color: var(--text-dim); line-height: 1.7; }
  /* â”€â”€ Chat panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #chat {
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  #messages {
    flex: 1;
    overflow-y: auto;
    padding: 24px 28px;
    display: flex;
    flex-direction: column;
    gap: 18px;
    scroll-behavior: smooth;
  }
  /* â”€â”€ Message bubbles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .msg { display: flex; gap: 12px; max-width: 780px; }
  .msg.user { align-self: flex-end; flex-direction: row-reverse; }
  .msg.bot  { align-self: flex-start; }
  .avatar {
    width: 34px; height: 34px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 1.1rem;
    flex-shrink: 0;
    margin-top: 2px;
  }
  .avatar.user-av { background: rgba(124,58,237,.25); border: 1px solid rgba(124,58,237,.4); }
  .avatar.bot-av  { background: rgba(168,85,247,.2);  border: 1px solid rgba(168,85,247,.4); }
  .bubble {
    padding: 12px 16px;
    border-radius: var(--radius);
    line-height: 1.65;
    font-size: .88rem;
    max-width: 100%;
    word-break: break-word;
  }
  .msg.user .bubble {
    background: var(--user-bg);
    border: 1px solid var(--border);
    border-top-right-radius: 3px;
  }
  .msg.bot .bubble {
    background: var(--bot-bg);
    border: 1px solid rgba(168,85,247,.25);
    border-top-left-radius: 3px;
  }
  .bubble pre {
    background: #0d1117;
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 14px;
    overflow-x: auto;
    font-family: var(--mono);
    font-size: .8rem;
    margin: 8px 0;
  }
  .bubble code { font-family: var(--mono); font-size: .82em; }
  .bubble strong { font-weight: 700; }
  .bubble em { font-style: italic; color: var(--text-dim); }
  /* streaming cursor */
  .cursor { display: inline-block; width: 8px; height: 1em; background: var(--accent2); vertical-align: text-bottom; animation: blink .8s step-end infinite; }
  @keyframes blink { 50% { opacity: 0; } }
  /* system / command result */
  .msg.system .bubble {
    background: rgba(210,153,34,.07);
    border-color: rgba(210,153,34,.25);
    color: var(--warning);
    font-family: var(--mono);
    font-size: .78rem;
  }
  /* â”€â”€ Input bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #input-area {
    border-top: 1px solid var(--border);
    padding: 14px 24px 16px;
    background: var(--surface);
    display: flex;
    align-items: flex-end;
    gap: 10px;
  }
  #input-wrap {
    flex: 1;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    display: flex;
    align-items: flex-end;
    padding: 10px 14px;
    gap: 10px;
    transition: border-color .2s;
  }
  #input-wrap:focus-within { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(124,58,237,.15); }
  #input {
    flex: 1;
    background: transparent;
    border: none;
    outline: none;
    color: var(--text);
    font-family: var(--font);
    font-size: .9rem;
    resize: none;
    max-height: 160px;
    line-height: 1.5;
  }
  #send-btn {
    width: 36px; height: 36px;
    border-radius: 9px;
    border: none;
    background: var(--accent);
    color: #fff;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: background .15s, transform .1s;
    flex-shrink: 0;
  }
  #send-btn:hover:not(:disabled) { background: var(--accent2); }
  #send-btn:active { transform: scale(.93); }
  #send-btn:disabled { background: var(--border); cursor: not-allowed; }
  #hint { font-size: .7rem; color: var(--text-dim); padding: 4px 26px 0; }
  /* â”€â”€ Empty state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #empty {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 16px;
    color: var(--text-dim);
    text-align: center;
    padding: 40px;
  }
  #empty .logo { font-size: 3.5rem; }
  #empty h2 { font-size: 1.4rem; color: var(--text); }
  #empty p  { font-size: .88rem; max-width: 380px; line-height: 1.6; }
  #empty ul { list-style: none; font-size: .82rem; margin-top: 6px; }
  #empty ul li::before { content: '/'; color: var(--accent2); margin-right: 5px; font-weight: 700; }
  /* â”€â”€ Scrollbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  ::-webkit-scrollbar { width: 5px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  /* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  @media (max-width: 680px) {
    #app { grid-template-columns: 1fr; }
    #sidebar { display: none; }
  }
</style>
</head>
<body>
<div id="app">

  <!-- â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <header id="header">
    <div id="conn-dot"></div>
    <h1>Sable <span>WebChat</span></h1>
    <span class="pill pill-secure">ğŸ”’ Unix Socket</span>
    <span id="conn-label">Connectingâ€¦</span>
    <div id="header-right">
      <span id="model-badge">â€”</span>
    </div>
  </header>

  <!-- â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <aside id="sidebar">
    <div id="sidebar-header">Sessions</div>
    <div id="sessions-list"><p style="padding:12px 16px;color:var(--text-dim);font-size:.8rem">No sessions yet</p></div>
    <div id="sidebar-footer">
      <div id="stats">Gateway: vâ€”<br>Uptime: â€”</div>
    </div>
  </aside>

  <!-- â”€â”€ Chat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <main id="chat">
    <div id="messages">
      <div id="empty">
        <div class="logo">ğŸ¤–</div>
        <h2>Sable is ready</h2>
        <p>Secure internal connection via Unix socket. No ports open. Type a message or a slash command.</p>
        <ul>
          <li>status â€” show session info</li>
          <li>reset  â€” clear conversation</li>
          <li>compact â€” summarise history</li>
          <li>model llama3.1:8b â€” switch model</li>
          <li>think high â€” set thinking depth</li>
        </ul>
      </div>
    </div>
    <div id="input-area">
      <div id="input-wrap">
        <textarea id="input" rows="1" placeholder="Message Sableâ€¦ or type /help"></textarea>
        <button id="send-btn" title="Send (Enter)">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
        </button>
      </div>
    </div>
    <div id="hint">Enter to send Â· Shift+Enter for new line Â· /help for commands</div>
  </main>

</div>

<script>
// â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SESSION_ID = 'webchat_' + Math.random().toString(36).slice(2, 10);
const USER_ID    = 'webchat_user';

// If a ?token= is present in the URL, forward it on the WS connection too.
// That way a bookmarked URL like http://100.x.x.x:8789/?token=abc works
// without any extra SSH tunnel.
const _params = new URLSearchParams(location.search);
const _token  = _params.get('token') || '';
const WS_URL  = _token
  ? `ws://${location.host}/?token=${encodeURIComponent(_token)}`
  : `ws://${location.host}/`;

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let ws         = null;
let streaming  = null;   // current streaming bubble element
let streamFull = '';
let reconnTimer = null;
let connecting  = false;

// â”€â”€ DOM refs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const $messages   = document.getElementById('messages');
const $empty      = document.getElementById('empty');
const $input      = document.getElementById('input');
const $sendBtn    = document.getElementById('send-btn');
const $connDot    = document.getElementById('conn-dot');
const $connLabel  = document.getElementById('conn-label');
const $modelBadge = document.getElementById('model-badge');
const $sessions   = document.getElementById('sessions-list');
const $stats      = document.getElementById('stats');

// â”€â”€ WebSocket â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function connect() {
  if (connecting) return;
  connecting = true;
  setConn(false, 'Connectingâ€¦');

  ws = new WebSocket(WS_URL);

  ws.onopen = () => {
    connecting = false;
    setConn(true, 'Connected');
    clearTimeout(reconnTimer);
    // Ask for session list + status
    ws.send(JSON.stringify({ type: 'sessions.list' }));
    ws.send(JSON.stringify({ type: 'status' }));
  };

  ws.onmessage = e => {
    try { handle(JSON.parse(e.data)); }
    catch(err) { console.warn('Parse error', err); }
  };

  ws.onerror = () => {};

  ws.onclose = () => {
    connecting = false;
    setConn(false, 'Disconnected â€“ retryingâ€¦');
    finishStream();
    reconnTimer = setTimeout(connect, 3500);
  };
}

function setConn(ok, label) {
  $connDot.className = ok ? 'on' : '';
  $connLabel.textContent = label;
  $sendBtn.disabled = !ok;
}

// â”€â”€ Message dispatch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handle(msg) {
  switch (msg.type) {
    case 'connected':
      // nothing extra needed
      break;

    case 'status':
      $modelBadge.textContent = msg.model || 'â€”';
      $stats.innerHTML =
        `Gateway: v${msg.version || 'â€”'}<br>` +
        `Uptime: ${fmtUptime(msg.uptime_sec)}<br>` +
        `Clients: ${msg.clients ?? 'â€”'}<br>` +
        `Nodes: ${(msg.nodes||[]).join(', ') || 'none'}`;
      break;

    case 'message.start':
      hideEmpty();
      streamFull = '';
      streaming = appendBubble('bot', '');
      streaming.querySelector('.bubble').appendChild(
        Object.assign(document.createElement('span'), { className: 'cursor' })
      );
      break;

    case 'message.chunk':
      streamFull += msg.text || '';
      if (streaming) {
        streaming.querySelector('.bubble').innerHTML = renderMarkdown(streamFull) +
          '<span class="cursor"></span>';
        scrollBottom();
      }
      break;

    case 'message.done':
      streamFull += msg.text || '';   // in case chunk was skipped
      if (streaming) {
        streaming.querySelector('.bubble').innerHTML = renderMarkdown(streamFull || msg.text || '');
        streaming = null;
        scrollBottom();
      }
      break;

    case 'command.result':
      hideEmpty();
      appendBubble('system', msg.text || '(no output)');
      break;

    case 'sessions.list.result':
      renderSessions(msg.sessions || []);
      break;

    case 'sessions.history.result':
      loadHistory(msg.messages || []);
      break;

    case 'error':
      finishStream();
      appendBubble('system', 'âš ï¸ ' + (msg.text || 'Unknown error'));
      break;

    case 'heartbeat':
      // Keep alive â€” no UI update needed
      break;
  }
}

// â”€â”€ Send â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function send() {
  const text = $input.value.trim();
  if (!text || !ws || ws.readyState !== WebSocket.OPEN) return;

  $input.value = '';
  autoResize();
  hideEmpty();

  if (text.startsWith('/')) {
    appendBubble('user', text);
    ws.send(JSON.stringify({ type: 'command', session_id: SESSION_ID, user_id: USER_ID, text }));
  } else {
    appendBubble('user', text);
    ws.send(JSON.stringify({ type: 'message', session_id: SESSION_ID, user_id: USER_ID, text }));
  }
}

$sendBtn.addEventListener('click', send);
$input.addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); }
});
$input.addEventListener('input', autoResize);

function autoResize() {
  $input.style.height = 'auto';
  $input.style.height = Math.min($input.scrollHeight, 160) + 'px';
}

// â”€â”€ Bubble factory â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function appendBubble(role, text) {
  const div    = document.createElement('div');
  const bubble = document.createElement('div');
  const av     = document.createElement('div');
  div.className    = 'msg ' + role;
  bubble.className = 'bubble';
  av.className     = 'avatar ' + (role === 'user' ? 'user-av' : 'bot-av');
  av.textContent   = role === 'user' ? 'ğŸ§‘' : (role === 'system' ? 'âš™ï¸' : 'ğŸ¤–');

  bubble.innerHTML = renderMarkdown(text);
  if (role === 'system') {
    div.appendChild(bubble);
  } else {
    div.appendChild(av);
    div.appendChild(bubble);
  }
  $messages.appendChild(div);
  scrollBottom();
  return div;
}

function hideEmpty() {
  if ($empty) $empty.style.display = 'none';
}

function finishStream() {
  if (streaming) {
    const c = streaming.querySelector('.cursor');
    if (c) c.remove();
    streaming = null;
  }
}

// â”€â”€ Sessions sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderSessions(sessions) {
  if (!sessions.length) {
    $sessions.innerHTML = '<p style="padding:12px 16px;color:var(--text-dim);font-size:.8rem">No sessions yet</p>';
    return;
  }
  $sessions.innerHTML = sessions.map(s => `
    <div class="session-item" data-id="${s.id}" onclick="loadSession('${s.id}')">
      <div class="s-ch">${escHtml(s.channel)} Â· ${escHtml(s.user_id)}</div>
      <div class="s-id">${s.id.slice(0,12)}â€¦</div>
      <div class="s-n">${s.messages} messages</div>
    </div>
  `).join('');
}

function loadSession(sid) {
  document.querySelectorAll('.session-item').forEach(el =>
    el.classList.toggle('active', el.dataset.id === sid)
  );
  ws && ws.send(JSON.stringify({ type: 'sessions.history', session_id: sid }));
}

function loadHistory(msgs) {
  hideEmpty();
  $messages.innerHTML = '';
  msgs.forEach(m => {
    if (m.role === 'system') return;
    appendBubble(m.role === 'assistant' ? 'bot' : 'user', m.content || '');
  });
}

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function scrollBottom() {
  requestAnimationFrame(() => { $messages.scrollTop = $messages.scrollHeight; });
}

function fmtUptime(sec) {
  if (!sec) return 'â€”';
  const h = Math.floor(sec / 3600);
  const m = Math.floor((sec % 3600) / 60);
  const s = Math.floor(sec % 60);
  return h ? `${h}h ${m}m` : m ? `${m}m ${s}s` : `${s}s`;
}

function escHtml(s) {
  return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}

// Minimal Markdown â†’ HTML (bold, italic, code, fenced code blocks, links)
function renderMarkdown(text) {
  let h = escHtml(text);
  // fenced code blocks
  h = h.replace(/```(\w+)?\n?([\s\S]*?)```/g, (_, lang, code) =>
    `<pre><code class="lang-${lang||''}">${code}</code></pre>`);
  // inline code
  h = h.replace(/`([^`]+)`/g, '<code>$1</code>');
  // bold
  h = h.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  // italic
  h = h.replace(/\*(.+?)\*/g, '<em>$1</em>');
  // links [text](url)
  h = h.replace(/\[([^\]]+)\]\((https?:\/\/[^\)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>');
  // newlines
  h = h.replace(/\n/g, '<br>');
  return h;
}

// Refresh sessions list every 30 s
setInterval(() => {
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({ type: 'sessions.list' }));
    ws.send(JSON.stringify({ type: 'status' }));
  }
}, 30_000);

// â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
connect();
</script>
</body>
</html>
